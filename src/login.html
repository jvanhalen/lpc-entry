<!doctype html>
<html lang="en">
<head>
 <meta charset="utf-8" />
 <title>Galaxy All-Stars: Medieval Edition Login</title>
 <link rel="stylesheet" href="style-login.css" type="text/css" />

    <!-- Maple stuff -->
    <script type="text/javascript" src="./lib/jquery-1.7.2.js"></script>
    <script type="text/javascript" src="./lib/jquery-validation-1.9.0/jquery.validate.min.js"></script>
    <script type="text/javascript" src="./lib/jquery.cookie.js"></script>
    <script type="text/javascript" charset="utf-8" src="../server/maple/lib/bison.js"></script>
    <script type="text/javascript" charset="utf-8" src="../server/maple/lib/Class.js"></script>
    <script type="text/javascript" charset="utf-8" src="../server/maple/lib/Twist.js"></script>
    <script type="text/javascript" charset="utf-8" src="../server/maple/Maple.js"></script>
    <script type="text/javascript" charset="utf-8" src="../server/maple/Client.js"></script>
    <script type="text/javascript" charset="utf-8" src="./lib/sha-hash.js"></script>
    <script type="text/javascript" charset="utf-8" src="./lib/crafty.js"></script>
<!--    <script type="text/javascript" charset="utf-8" src="./lib/tweenjs-0.3.0.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="./lib/easeljs-0.5.0.min.js"></script> -->
    <script type="text/javascript" charset="utf-8" src="./lib/pathfinding-browser.js"></script>
    <script type="text/javascript" charset="utf-8" src="./lib/Queue.compressed.js"></script>
    <script type="text/javascript" charset="utf-8" src="ape-component.js"></script>
    <script type="text/javascript" charset="utf-8" src="effects.js"></script>
    <script type="text/javascript" charset="utf-8" src="gas-client.js"></script>
    <script type="text/javascript" charset="utf-8" src="./characters.js"></script>


    <script type="text/javascript">
    var type=10;
    function setType(value)
    {
	    type = value;
    }
    </script>

    <script type="text/javascript" charset="utf-8">
     // ****************************************
     // validator plugin settings: when submitted,
     // we use GAS Maple server for authentication.
     // ****************************************
     $.validator.setDefaults({
	 submitHandler: function() {
      var hashPass = Sha1.hash($('#password').val());
      var login = $('#username').val();
       // set cookie for later use
       $.cookie('gas-login', JSON.stringify({"username":login, "sessionid":hashPass}));
       gas.send(type, [ JSON.stringify({"username":login, "password":hashPass}) ]);
     }
     });
     // ****************************************
     // validator plugin rules for login form
     // ****************************************
      $().ready(function(){

	  // TODO: Create a custom (animated) cursor for "manager"
	   //$('*').css('cursor','pointer');
	   	$('*').css('cursor', 'url("../pics/gauntlet_cursor.png"), pointer');

        $('#loginform').validate({
         rules: {
         	username: { required: true, minlength: 3, maxlength: 12 },
         	password: { required: true, minlength: 4, maxlength: 12 }	// TODO: minlength 4 -> 6 before releasing the game
         }});


	$("#username").keypress(function(event) {
		event.preventDefault;
		var $th = $(this);
		$th.val( $th.val().replace(/[^a-zA-Z0-9]/g, function(str) { return ''; } ) );

	})

	$("#username").keydown(function(event) {
		event.preventDefault;
		var $th = $(this);
		$th.val( $th.val().replace(/[^a-zA-Z0-9]/g, function(str) { return ''; } ) );

	})

	$("#typearea").keydown(function(event) {
		if(event.keyCode == 13) {
			if($("#typearea").val() != "") {
				//$("#chatbox").val($("#typearea").val());
				var user = JSON.parse($.cookie("gas-login")).username
				var message = $("#typearea").val();

				// TODO: "a scripting language", i.e. simple commands via command line
				if($("#typearea").val() == "clear;") {
					$('#chatbox').empty();
				}
				else if($("#typearea").val() == "help;") {
					$('#chatbox').append("<b>clear;</b> clear the chatbox<br /><b>help;</b> this help<br />");
				}
				else {
					gas.send("CLIENT_CHAT_REQ", ['{"username": "' + user + '", "message": "' + message + '"}']);
				}

				$("#typearea").val("");
		    }
		}
	});
 })

    </script>

    <script type="text/javascript" charset="utf-8">

      function logout()
      {
		 Crafty.audio.stop();
		 Crafty.stop();
			 //$.cookie("gas-login").username = null;
		 location.reload(true);

      }

      function displayLogin()
      {
           g_smokeScreen.attr({changeToScene:"loadingView"}).tween({alpha:1.0},50);

           $('#login').fadeOut(500, function(){
                $('#login').empty();
                $('#login').html('<div id="welcome_title">Enjoy your stay, '+JSON.parse($.cookie("gas-login")).username+'!</div><br />').append($('#login-nav').html());
                $('#login').fadeIn('fast', function(){
                    //Crafty.scene("loadingView");
                });

           });
      }

    </script>
</head>

<body>

  <div id="login-nav">
    	<button type="submit" id="logout" onclick="logout();"> &gt;&gt;&nbsp;&nbsp;Logout</button>
  </div>
  <div id="login">
    <form method="post" id="loginform" action="#">
      <fieldset>
	<div class="form-element">
          <label for="username">Username</label>
          <input type="text" name="username" id="username" class="required" maxlength="12"/>
        </div>
	<div class="form-element">
  	  <label for="password">Password</label>
	  <input name="password" type="password" id="password" class="required" maxlength="12" />
	</div>
      </fieldset>
      <fieldset>
        <button type="submit" id="loginbtn" title="Log in to an existing account" onclick="setType('LOGIN_REQ');"> &gt;&gt;&nbsp;&nbsp;Login</button>
	<button type="submit" id="createbtn" title="Create new team" onclick="setType('CREATE_USER_REQ');"> &gt;&gt;&nbsp;&nbsp;Create</button>
      </fieldset>
    </form>
  </div>



  <div id="ranking">
  </div>
  <script>
	Crafty.init(800, 800);
    Crafty.background('#4d5155');
    // Connect to GAS server
    var gas = new GAS();

    // create default smokescreen
     g_smokeScreen = Crafty.e("2D, DOM, Tween, Persist, Color")
       .attr({x:0, y:0, w:800, h:800, alpha:0.0, z:10})
       .color("#000000")
       .bind("TweenEnd", function(){
         console.log("Smokescreen faded", g_smokeScreen.alpha == 0.0 ? "out" : "in");
         if ( g_smokeScreen.alpha == 1.0 )
            Crafty.scene(g_smokeScreen.changeToScene);
        });



    //gas.connect('gassrv.dyndns.org', 8080);
    gas.connect('localhost', 8080);
    Crafty.scene("managerView", showManagerView, hideManagerView);
    Crafty.scene("gladiatorView", showGladiatorView, hideGladiatorView);
    Crafty.scene("arenaView", showArenaView, hideArenaView);
    Crafty.scene("gladiatorPitView", showGladiatorPitView, hideGladiatorPitView);
    Crafty.scene("loginView", showLoginView, hideLoginView);

    var assetArray = [];
    GetLoadableAssetsFromTileMap( 'test.json',      assetArray);
    GetLoadableAssetsFromTileMap( 'inventory.json', assetArray);
    GetLoadableAssetsFromTileMap( 'arena.json',     assetArray);
    PreloadAnimation("skeleton-body.json");
    PreloadAnimation("human-body.json");
    PreloadAnimation("robe.json");
    PreloadAnimation("leather-armor.json");
    PreloadAnimation("plate-armor.json");
    PreloadAnimation("chain-armor.json");
    PreloadAnimation("no-armor.json");
    PreloadAnimation("long-spear.json");
    



    Crafty.scene("loadingView", function(){
       console.log('Loading');
       for( var i=0;i< assetArray.length;i++)
       {
          console.log('About to load'+assetArray[i]);
       }
       Crafty.load(assetArray, function(e){
                       console.log('Done loading, starting manager!');
                       Crafty.scene("managerView"); });

       Crafty.e("2D, DOM, Text").attr({ w: 100, h: 20, x: 150, y: 120 })
      .text("Loading")
      .css({ "text-align": "center" });
    });
    Crafty.scene("loginView");


    if ( $.cookie("gas-login")) {
		var loginstring = {
		'username': JSON.parse($.cookie("gas-login")).username,
		'sessionid': JSON.parse($.cookie("gas-login")).sessionid
		}
        gas.send('LOGIN_REQ', [ JSON.stringify(loginstring) ]);
	}

    // Ignore login for development..
/*    $('#login').fadeOut(500, function(){
           $('#login').empty();
                       Crafty.scene("loadingView");
                       });
*/

  </script>

  <div id="interaction" class="container">
	  <div id="managers" class="block">
	    <div id="managers_title"></div>
	    <div id="managers_body"></div>
	    <div id="chatbox"></div>
	    <div>
		<input type="text" id="typearea" style="width:250px" value="help;" />
	    </div>
      </div>
      <div id="challenges">
      </div>
  </div>

</body>
</html>
